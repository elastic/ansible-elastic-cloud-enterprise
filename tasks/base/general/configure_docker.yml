---
- name: Ensures /etc/systemd/system/docker.service.d dir exists
  file:
    path: /etc/systemd/system/docker.service.d
    state: directory
  when: docker_version != '1.13'
  notify: Restart docker

- name: Create service.d docker.conf
  template:
    src: docker.conf
    dest: /etc/systemd/system/docker.service.d/docker.conf
  when: docker_version != '1.13'
  notify: Restart docker

- name: set docker storage options
  lineinfile:
    path: /etc/sysconfig/docker
    regexp: "^OPTIONS='(.*)'"
    line: "OPTIONS='-g {{ data_dir }}/docker \\1'"
    backrefs: yes
    create: yes
  when: docker_version == '1.13'
  notify: Restart docker

- name: set docker network options
  lineinfile:
    path: /etc/sysconfig/docker-network
    regexp: '^DOCKER_NETWORK_OPTIONS='
    line: 'DOCKER_NETWORK_OPTIONS="--bip={{ docker_bridge_ip }}"'
    create: yes
  when: docker_version == '1.13'
  notify: Restart docker

- name: set docker storage driver
  lineinfile:
    path: /etc/sysconfig/docker-storage-setup
    regexp: '^DOCKER_NETWORK_OPTIONS='
    line: 'STORAGE_DRIVER={{ docker_storage_driver }}'
    create: yes
  when: docker_version == '1.13'
  notify: Restart docker

- name: Remove var/lib/docker
  file:
    path: /var/lib/docker
    state: absent
    force: yes

- name: Flush handlers to trigger the (re-)start of docker if needed
  meta: flush_handlers
